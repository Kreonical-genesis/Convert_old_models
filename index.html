<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Model Converter</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .drop-zone { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; cursor: pointer; }
        .drop-zone.dragover { background: #f0f0f0; border-color: #999; }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; margin: 5px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.danger { background: #f44336; }
        .file-list { margin: 20px 0; }
        .file-item { display: flex; align-items: center; padding: 8px; background: #f9f9f9; margin: 5px 0; border-radius: 4px; }
        .file-name { flex: 1; }
        .file-status { margin-left: 10px; font-size: 0.9em; }
        .status-success { color: #4CAF50; }
        .status-error { color: #f44336; }
        .status-pending { color: #ff9800; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px; border-radius: 4px; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <h1>üîÑ Minecraft Model Converter</h1>
    <p>–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ 1.9.0 –≤ 1.21.11</p>
    
    <div class="drop-zone" id="dropZone">
        üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏ ZIP-–∞—Ä—Ö–∏–≤—ã —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞
        <input type="file" id="fileInput" multiple accept=".zip,.mcpack,.mcaddon" style="display: none;">
    </div>
    
    <div class="file-list" id="fileList">
        <h3>–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: <span id="fileCount">0</span></h3>
        <div id="fileItems"></div>
    </div>
    
    <div class="button-group">
        <button id="convertBtn" disabled>üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ</button>
        <button id="downloadAllBtn" disabled>üì¶ –°–∫–∞—á–∞—Ç—å –≤—Å–µ (–ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏)</button>
        <button id="downloadSingleZipBtn" disabled>üì¶ –°–∫–∞—á–∞—Ç—å –æ–¥–Ω–∏–º –∞—Ä—Ö–∏–≤–æ–º</button>
        <button id="clearBtn" class="danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>
    
    <h3>–õ–æ–≥:</h3>
    <div class="log" id="log"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileItems = document.getElementById('fileItems');
        const fileCount = document.getElementById('fileCount');
        const convertBtn = document.getElementById('convertBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const downloadSingleZipBtn = document.getElementById('downloadSingleZipBtn');
        const clearBtn = document.getElementById('clearBtn');
        const log = document.getElementById('log');
        
        let files = []; // –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
        let convertedFiles = new Map(); // –∏–º—è -> { blob, count, originalName }
        
        function addLog(message, isError = false) {
            const prefix = isError ? '‚ùå' : '‚úì';
            log.innerHTML += `[${new Date().toLocaleTimeString()}] ${prefix} ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            log.innerHTML = '';
        }
        
        function convertRotation(oldRotation) {
            if (!oldRotation || typeof oldRotation !== 'object') return oldRotation;
            if (oldRotation.x !== undefined || oldRotation.y !== undefined || oldRotation.z !== undefined) {
                return oldRotation;
            }
            if (oldRotation.angle !== undefined && oldRotation.axis !== undefined) {
                const newRotation = { origin: oldRotation.origin || [0, 0, 0] };
                newRotation.x = oldRotation.axis === 'x' ? oldRotation.angle : 0;
                newRotation.y = oldRotation.axis === 'y' ? oldRotation.angle : 0;
                newRotation.z = oldRotation.axis === 'z' ? oldRotation.angle : 0;
                return newRotation;
            }
            return oldRotation;
        }
        
        function convertModel(modelData) {
            if (!modelData || typeof modelData !== 'object') return modelData;
            
            if (modelData.format_version) {
                modelData.format_version = "1.21.11";
            }
            
            if (modelData.elements && Array.isArray(modelData.elements)) {
                modelData.elements.forEach(element => {
                    if (element.rotation) {
                        element.rotation = convertRotation(element.rotation);
                    }
                });
            }
            
            return modelData;
        }
        
        async function processZip(file) {
            addLog(`–û–±—Ä–∞–±–æ—Ç–∫–∞: ${file.name}`);
            
            try {
                const zip = new JSZip();
                const contents = await zip.loadAsync(file);
                const newZip = new JSZip();
                let modelCount = 0;
                
                const promises = [];
                contents.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir) {
                        const promise = zipEntry.async('string').then(content => {
                            if (relativePath.includes('models/item/') && relativePath.endsWith('.json')) {
                                try {
                                    const modelData = JSON.parse(content);
                                    const converted = convertModel(modelData);
                                    newZip.file(relativePath, JSON.stringify(converted, null, 2));
                                    modelCount++;
                                    addLog(`  ‚úÖ ${relativePath}`);
                                } catch (e) {
                                    addLog(`  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ ${relativePath}: ${e.message} (—Å–æ—Ö—Ä–∞–Ω—ë–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª)`, true);
                                    newZip.file(relativePath, content);
                                }
                            } else {
                                newZip.file(relativePath, content);
                            }
                        });
                        promises.push(promise);
                    }
                });
                
                await Promise.all(promises);
                
                const zipBlob = await newZip.generateAsync({ type: 'blob' });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const newName = file.name.replace(/\.(zip|mcpack|mcaddon)$/, '_converted.zip');
                convertedFiles.set(file.name, { 
                    blob: zipBlob, 
                    count: modelCount,
                    newName: newName,
                    originalName: file.name 
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Å–ø–∏—Å–∫–µ
                updateFileStatus(file.name, 'success', `‚úÖ ${modelCount} –º–æ–¥–µ–ª–µ–π`);
                addLog(`‚úÖ –ì–æ—Ç–æ–≤–æ: ${file.name} ‚Üí ${newName} (${modelCount} –º–æ–¥–µ–ª–µ–π)`);
                
            } catch (e) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${file.name}: ${e.message}`, true);
                updateFileStatus(file.name, 'error', '‚ùå –û—à–∏–±–∫–∞');
            }
            
            updateButtons();
        }
        
        function updateFileStatus(fileName, status, statusText) {
            const item = document.querySelector(`[data-file="${fileName}"]`);
            if (item) {
                const statusSpan = item.querySelector('.file-status');
                statusSpan.className = `file-status status-${status}`;
                statusSpan.textContent = statusText;
            }
        }
        
        function renderFileList() {
            if (files.length === 0) {
                fileItems.innerHTML = '<p>–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>';
                fileCount.textContent = '0';
                return;
            }
            
            let html = '';
            files.forEach(file => {
                const converted = convertedFiles.get(file.name);
                const status = converted ? 
                    `<span class="file-status status-success">‚úÖ ${converted.count} –º–æ–¥–µ–ª–µ–π</span>` : 
                    `<span class="file-status status-pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</span>`;
                
                html += `
                    <div class="file-item" data-file="${file.name}">
                        <span class="file-name">üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                        ${status}
                    </div>
                `;
            });
            
            fileItems.innerHTML = html;
            fileCount.textContent = files.length;
        }
        
        function updateButtons() {
            convertBtn.disabled = files.length === 0;
            downloadAllBtn.disabled = convertedFiles.size === 0;
            downloadSingleZipBtn.disabled = convertedFiles.size === 0;
        }
        
        // Drag & drop
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const droppedFiles = Array.from(e.dataTransfer.files)
                .filter(f => f.name.match(/\.(zip|mcpack|mcaddon)$/i));
            
            droppedFiles.forEach(file => {
                if (!files.some(f => f.name === file.name)) {
                    files.push(file);
                }
            });
            
            renderFileList();
            updateButtons();
        });
        
        fileInput.addEventListener('change', (e) => {
            const selectedFiles = Array.from(e.target.files);
            selectedFiles.forEach(file => {
                if (!files.some(f => f.name === file.name)) {
                    files.push(file);
                }
            });
            renderFileList();
            updateButtons();
        });
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
        convertBtn.addEventListener('click', async () => {
            addLog('üîÑ –ù–∞—á–∞–ª–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏...');
            convertedFiles.clear();
            
            for (const file of files) {
                await processZip(file);
            }
            
            renderFileList();
            addLog('‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
        });
        
        // –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
        downloadAllBtn.addEventListener('click', () => {
            for (const [_, data] of convertedFiles) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(data.blob);
                link.download = data.newName;
                link.click();
                URL.revokeObjectURL(link.href);
            }
            addLog(`üì¶ –°–∫–∞—á–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${convertedFiles.size}`);
        });
        
        // –°–∫–∞—á–∞—Ç—å –æ–¥–Ω–∏–º –∞—Ä—Ö–∏–≤–æ–º (ZIP –≤–Ω—É—Ç—Ä–∏ ZIP - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ!)
        downloadSingleZipBtn.addEventListener('click', async () => {
            addLog('üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—â–µ–≥–æ –∞—Ä—Ö–∏–≤–∞...');
            
            const finalZip = new JSZip();
            
            for (const [_, data] of convertedFiles) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ZIP –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –≤ –∫–æ—Ä–µ–Ω—å
                finalZip.file(data.newName, data.blob);
            }
            
            const blob = await finalZip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'all_converted_packs.zip';
            link.click();
            
            addLog(`‚úÖ –û–±—â–∏–π –∞—Ä—Ö–∏–≤ all_converted_packs.zip —Å–æ–∑–¥–∞–Ω (${convertedFiles.size} —Ñ–∞–π–ª–æ–≤)`);
        });
        
        // –û—á–∏—Å—Ç–∫–∞
        clearBtn.addEventListener('click', () => {
            files = [];
            convertedFiles.clear();
            renderFileList();
            updateButtons();
            clearLog();
            addLog('üóëÔ∏è –°–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω');
        });
    </script>
</body>
</html>