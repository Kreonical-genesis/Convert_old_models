<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Model Converter</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .drop-zone { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; cursor: pointer; }
        .drop-zone.dragover { background: #f0f0f0; border-color: #999; }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; }
        .file-list { margin: 20px 0; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üîÑ Minecraft Model Converter</h1>
    <p>–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ 1.9.0 –≤ 1.21.11</p>
    
    <div class="drop-zone" id="dropZone">
        üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏ ZIP-–∞—Ä—Ö–∏–≤—ã —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞
        <input type="file" id="fileInput" multiple accept=".zip" style="display: none;">
    </div>
    
    <div class="file-list" id="fileList"></div>
    
    <button id="convertBtn" disabled>üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ</button>
    <button id="downloadAllBtn" disabled style="margin-left: 10px;">üì¶ –°–∫–∞—á–∞—Ç—å –≤—Å—ë (ZIP)</button>
    
    <h3>–õ–æ–≥:</h3>
    <div class="log" id="log"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const convertBtn = document.getElementById('convertBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const log = document.getElementById('log');
        
        let files = [];
        let convertedFiles = new Map(); // –∏–º—è -> JSZip –æ–±—ä–µ–∫—Ç
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function addLog(message) {
            log.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è rotation
        function convertRotation(oldRotation) {
            if (!oldRotation || typeof oldRotation !== 'object') return oldRotation;
            if (oldRotation.x !== undefined || oldRotation.y !== undefined || oldRotation.z !== undefined) {
                return oldRotation;
            }
            if (oldRotation.angle !== undefined && oldRotation.axis !== undefined) {
                const newRotation = { origin: oldRotation.origin || [0, 0, 0] };
                newRotation.x = oldRotation.axis === 'x' ? oldRotation.angle : 0;
                newRotation.y = oldRotation.axis === 'y' ? oldRotation.angle : 0;
                newRotation.z = oldRotation.axis === 'z' ? oldRotation.angle : 0;
                return newRotation;
            }
            return oldRotation;
        }
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
        function convertModel(modelData) {
            if (!modelData || typeof modelData !== 'object') return modelData;
            
            if (modelData.format_version) {
                modelData.format_version = "1.21.11";
            }
            
            if (modelData.elements && Array.isArray(modelData.elements)) {
                modelData.elements.forEach(element => {
                    if (element.rotation) {
                        element.rotation = convertRotation(element.rotation);
                    }
                });
            }
            
            return modelData;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ZIP —Ñ–∞–π–ª–∞
        async function processZip(file) {
            addLog(`üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞: ${file.name}`);
            
            try {
                const zip = new JSZip();
                const contents = await zip.loadAsync(file);
                const newZip = new JSZip();
                let modelCount = 0;
                
                const promises = [];
                contents.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir) {
                        const promise = zipEntry.async('string').then(content => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª JSON –º–æ–¥–µ–ª—å—é –ø—Ä–µ–¥–º–µ—Ç–∞
                            if (relativePath.includes('models/item/') && relativePath.endsWith('.json')) {
                                try {
                                    const modelData = JSON.parse(content);
                                    const converted = convertModel(modelData);
                                    newZip.file(relativePath, JSON.stringify(converted, null, 2));
                                    modelCount++;
                                    addLog(`  ‚úÖ ${relativePath}`);
                                } catch (e) {
                                    addLog(`  ‚ùå –û—à–∏–±–∫–∞ –≤ ${relativePath}: ${e.message}`);
                                    newZip.file(relativePath, content); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                                }
                            } else {
                                newZip.file(relativePath, content);
                            }
                        });
                        promises.push(promise);
                    }
                });
                
                await Promise.all(promises);
                
                const zipBlob = await newZip.generateAsync({ type: 'blob' });
                convertedFiles.set(file.name, { blob: zipBlob, count: modelCount });
                
                addLog(`‚úÖ –ì–æ—Ç–æ–≤–æ: ${file.name} (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –º–æ–¥–µ–ª–µ–π: ${modelCount})`);
                return true;
            } catch (e) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${file.name}: ${e.message}`);
                return false;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
        function updateFileList() {
            fileList.innerHTML = '<h3>–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:</h3>';
            files.forEach(file => {
                const div = document.createElement('div');
                div.textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                fileList.appendChild(div);
            });
            
            convertBtn.disabled = files.length === 0;
            downloadAllBtn.disabled = convertedFiles.size === 0;
        }
        
        // Drag & drop –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const droppedFiles = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.zip'));
            files = [...files, ...droppedFiles];
            updateFileList();
        });
        
        fileInput.addEventListener('change', (e) => {
            const selectedFiles = Array.from(e.target.files);
            files = [...files, ...selectedFiles];
            updateFileList();
        });
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
        convertBtn.addEventListener('click', async () => {
            addLog('üîÑ –ù–∞—á–∞–ª–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏...');
            convertedFiles.clear();
            downloadAllBtn.disabled = true;
            
            for (const file of files) {
                await processZip(file);
            }
            
            downloadAllBtn.disabled = convertedFiles.size === 0;
            addLog('‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
        });
        
        // –°–∫–∞—á–∞—Ç—å –≤—Å—ë –æ–¥–Ω–∏–º –∞—Ä—Ö–∏–≤–æ–º
        downloadAllBtn.addEventListener('click', async () => {
            const finalZip = new JSZip();
            
            for (const [originalName, data] of convertedFiles) {
                const newName = originalName.replace('.zip', '_converted.zip');
                finalZip.file(newName, data.blob);
            }
            
            const blob = await finalZip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'converted_packs.zip';
            link.click();
            
            addLog('üì¶ –ê—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ —Å–∫–∞—á–∞–Ω');
        });
        
        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞
        function clearLog() {
            log.innerHTML = '';
        }
    </script>
</body>
</html>